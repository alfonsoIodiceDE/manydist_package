"0","# MDS Visualization"
"0","cat(""\n=== MDS VISUALIZATION FOR CLUSTERING RESULTS ===\n"")"
"1","
=== MDS VISUALIZATION FOR CLUSTERING RESULTS ===
"
"0","create_mds_cluster_plot <- function(enhanced_data_with_clusters, cycle_name) {"
"0","  cat(sprintf(""\n→ Creating MDS plot for PISA %s intervention clusters...\n"", cycle_name))"
"0","  "
"0","  cycle_data <- enhanced_data_with_clusters[[cycle_name]]"
"0","  "
"0","  if (!""CLUSTER_INTERVENTION"" %in% names(cycle_data$data)) {"
"0","    cat(""No intervention clusters found\n"")"
"0","    return(NULL)"
"0","  }"
"0","  "
"0","  data_with_clusters <- cycle_data$data"
"0","  clusters <- data_with_clusters$CLUSTER_INTERVENTION"
"0","  n_clusters <- length(unique(clusters))"
"0","  "
"0","  clustering_vars <- cycle_data$clustering_vars"
"0","  if (length(clustering_vars) == 0) {"
"0","    cat(""No clustering variables available for MDS\n"")"
"0","    return(NULL)"
"0","  }"
"0","  "
"0","  # Prepare data for MDS"
"0","  cluster_matrix <- data_with_clusters[, clustering_vars, with = FALSE]"
"0","  complete_cases <- complete.cases(cluster_matrix)"
"0","  "
"0","  if (sum(complete_cases) < 50) {"
"0","    cat(""Too few complete cases for reliable MDS\n"")"
"0","    return(NULL)"
"0","  }"
"0","  "
"0","  cluster_matrix_complete <- cluster_matrix[complete_cases, ]"
"0","  clusters_complete <- clusters[complete_cases]"
"0","  data_complete <- data_with_clusters[complete_cases, ]"
"0","  "
"0","  tryCatch({"
"0","    # Calculate Gower distance matrix"
"0","    dist_matrix <- cluster::daisy(cluster_matrix_complete, metric = ""gower"")"
"0","    "
"0","    cat(sprintf(""Calculated distance matrix for %d observations\n"", nrow(cluster_matrix_complete)))"
"0","    "
"0","    # Perform ordinal MDS"
"0","    classical_mds <- cmdscale(dist_matrix, k = 2)"
"0","    ordinal_mds <- isoMDS(dist_matrix, y = classical_mds, k = 2, "
"0","                          maxit = 100, trace = FALSE)"
"0","    "
"0","    stress_value <- ordinal_mds$stress"
"0","    stress_interpretation <- if (stress_value < 0.05) ""Excellent"" "
"0","                            else if (stress_value < 0.10) ""Good"" "
"0","                            else if (stress_value < 0.20) ""Fair"" "
"0","                            else ""Poor"""
"0","    "
"0","    cat(sprintf(""Ordinal MDS Stress: %.4f (%s)\n"", stress_value, stress_interpretation))"
"0","    "
"0","    # Create plotting data"
"0","    plot_data <- data.frame("
"0","      MDS1 = ordinal_mds$points[, 1],"
"0","      MDS2 = ordinal_mds$points[, 2],"
"0","      Cluster = as.factor(clusters_complete),"
"0","      RESILIENT = as.factor(data_complete$RESILIENT),"
"0","      ESCS = data_complete$ESCS"
"0","    )"
"0","    "
"0","    # Calculate cluster-specific resilience rates for labels"
"0","    cluster_labels <- c()"
"0","    for (cluster_id in sort(unique(clusters_complete))) {"
"0","      cluster_mask <- clusters_complete == cluster_id"
"0","      resilience_rate <- mean(data_complete$RESILIENT[cluster_mask], na.rm = TRUE) * 100"
"0","      n_students <- sum(cluster_mask)"
"0","      "
"0","      label <- sprintf(""Cluster %d\n(n=%d, %.1f%% resilient)"", "
"0","                       cluster_id, n_students, resilience_rate)"
"0","      cluster_labels <- c(cluster_labels, label)"
"0","    }"
"0","    "
"0","    # Main MDS plot with clusters and resilience"
"0","    p1 <- ggplot(plot_data, aes(x = MDS1, y = MDS2)) +"
"0","      geom_point(aes(color = Cluster, shape = RESILIENT), "
"0","                 alpha = 0.7, size = 2.5) +"
"0","      stat_ellipse(aes(color = Cluster), type = ""norm"", level = 0.68, alpha = 0.3) +"
"0","      scale_color_viridis_d(name = ""Cluster"", labels = cluster_labels) +"
"0","      scale_shape_manual(name = ""Resilient"", "
"0","                         values = c(""0"" = 16, ""1"" = 17),"
"0","                         labels = c(""0"" = ""Not Resilient"", ""1"" = ""Resilient"")) +"
"0","      labs("
"0","        title = sprintf(""MDS Clustering Visualization: PISA %s (Intervention)"", cycle_name),"
"0","        subtitle = sprintf(""Gower Distance | Stress: %.4f (%s) | %d variables"", "
"0","                           stress_value, stress_interpretation, length(clustering_vars)),"
"0","        x = ""MDS Dimension 1"","
"0","        y = ""MDS Dimension 2"","
"0","        caption = sprintf(""Akhanli & Hennig Framework | %d complete observations"", nrow(plot_data))"
"0","      ) +"
"0","      theme_minimal() +"
"0","      theme("
"0","        plot.title = element_text(size = 14, face = ""bold""),"
"0","        plot.subtitle = element_text(size = 12),"
"0","        legend.position = ""right"","
"0","        panel.grid.minor = element_blank()"
"0","      )"
"0","    "
"0","    # ESCS overlay plot"
"0","    p2 <- ggplot(plot_data, aes(x = MDS1, y = MDS2)) +"
"0","      geom_point(aes(color = ESCS), size = 2.5, alpha = 0.8) +"
"0","      scale_color_gradient2(name = ""ESCS\n(SES Index)"", "
"0","                            low = ""red"", mid = ""white"", high = ""blue"", "
"0","                            midpoint = median(plot_data$ESCS, na.rm = TRUE)) +"
"0","      stat_ellipse(aes(group = Cluster), color = ""gray50"", linetype = ""dashed"", alpha = 0.5) +"
"0","      labs("
"0","        title = sprintf(""Socioeconomic Status Distribution: PISA %s"", cycle_name),"
"0","        subtitle = sprintf(""Overlaid on MDS coordinates | Stress: %.4f"", stress_value),"
"0","        x = ""MDS Dimension 1"", y = ""MDS Dimension 2"""
"0","      ) +"
"0","      theme_minimal() +"
"0","      theme(panel.grid.minor = element_blank())"
"0","    "
"0","    # Print plots"
"0","    print(p1)"
"0","    print(p2)"
"0","    "
"0","    return(list("
"0","      main = p1, "
"0","      escs = p2, "
"0","      stress = stress_value, "
"0","      n_obs = nrow(plot_data),"
"0","      cluster_labels = cluster_labels"
"0","    ))"
"0","    "
"0","  }, error = function(e) {"
"0","    cat(sprintf(""Error in MDS calculation: %s\n"", e$message))"
"0","    return(NULL)"
"0","  })"
"0","}"
"0",""
"0","# Generate MDS plots for all cycles"
"0","mds_plots <- list()"
"0","for (cycle_name in names(enhanced_data_with_clusters)) {"
"0","  if (""CLUSTER_INTERVENTION"" %in% names(enhanced_data_with_clusters[[cycle_name]]$data)) {"
"0","    plots <- create_mds_cluster_plot(enhanced_data_with_clusters, cycle_name)"
"0","    if (!is.null(plots)) {"
"0","      mds_plots[[cycle_name]] <- plots"
"0","    }"
"0","  }"
"0","}"
"1","
→ Creating MDS plot for PISA 2015 intervention clusters...
"
"1","Calculated distance matrix for 1373 observations
"
"1","Ordinal MDS Stress: 27.1307 (Poor)
"
"1","
→ Creating MDS plot for PISA 2018 intervention clusters...
"
"1","Calculated distance matrix for 1593 observations
"
"1","Ordinal MDS Stress: 27.4640 (Poor)
"
"1","
→ Creating MDS plot for PISA 2022 intervention clusters...
"
"1","Calculated distance matrix for 1579 observations
"
"1","Ordinal MDS Stress: 29.0988 (Poor)
"
