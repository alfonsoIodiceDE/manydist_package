"0","cat(""\n=== DATA PREPARATION WITH MICE IMPUTATION ===\n"")"
"1","
=== DATA PREPARATION WITH MICE IMPUTATION ===
"
"0","prepare_clustering_data <- function(cycle_data, cycle_vars, cycle_name,"
"0","                                   missing_threshold = 0.3, mice_iterations = 5) {"
"0","  "
"0","  cat(sprintf(""→ Preparing clustering dataset for PISA %s...\n"", cycle_name))"
"0","  "
"0","  essential_cols <- c(""RESILIENT"", ""RESILIENT_OECD"", ""CYCLE"", ""W_FSTUWT"", ""CNTSTUID"", ""CNTSCHID"")"
"0","  available_essential <- intersect(essential_cols, names(cycle_data))"
"0","  "
"0","  all_vars <- c(cycle_vars, available_essential)"
"0","  clustering_data <- cycle_data[, all_vars, with = FALSE]"
"0","  "
"0","  for (col_name in names(clustering_data)) {"
"0","    if (inherits(clustering_data[[col_name]], ""haven_labelled"")) {"
"0","      clustering_data[[col_name]] <- as.numeric(clustering_data[[col_name]])"
"0","    }"
"0","  }"
"0","  "
"0","  cat(""→ Analyzing missing value patterns...\n"")"
"0","  missing_summary <- clustering_data[, lapply(.SD, function(x) sum(is.na(x))/length(x)),"
"0","                                     .SDcols = cycle_vars]"
"0","  "
"0","  good_vars <- names(missing_summary)[missing_summary <= missing_threshold]"
"0","  dropped_vars <- names(missing_summary)[missing_summary > missing_threshold]"
"0","  "
"0","  good_vars_for_clustering <- setdiff(good_vars, c(""RESILIENT"", ""RESILIENT_OECD""))"
"0","  "
"0","  if (length(dropped_vars) > 0) {"
"0","    cat(sprintf(""⚠ Dropped %d variables with >%.0f%% missingness\n"","
"0","                length(dropped_vars), missing_threshold * 100))"
"0","  }"
"0","  "
"0","  final_vars <- c(good_vars_for_clustering, available_essential)"
"0","  clustering_data <- clustering_data[, final_vars, with = FALSE]"
"0","  "
"0","  categorical_vars <- c(""ST004D01T"", ""IMMIG"", ""SCHLTYPE"", ""TESTLANG"", ""PARINVOL"", ""EQUITYPOL"")"
"0","  pattern_categorical <- good_vars_for_clustering[grepl(""^ST[0-9].*Q[0-9]|IMMIG|SCHLTYPE|TESTLANG|PARINVOL|EQUITYPOL|SKIP|TARDY|GENDER|CNT$"", good_vars_for_clustering)]"
"0","  categorical_vars <- unique(c(categorical_vars, pattern_categorical))"
"0","  available_categorical <- intersect(categorical_vars, good_vars_for_clustering)"
"0","  "
"0","  continuous_vars <- setdiff(good_vars_for_clustering, available_categorical)"
"0","  "
"0","  for (var in available_categorical) {"
"0","    if (var %in% names(clustering_data)) {"
"0","      clustering_data[[var]] <- as.factor(clustering_data[[var]])"
"0","    }"
"0","  }"
"0","  "
"0","  remaining_missing <- clustering_data[, lapply(.SD, function(x) sum(is.na(x))),"
"0","                                       .SDcols = good_vars_for_clustering]"
"0","  total_missing <- sum(unlist(remaining_missing))"
"0","  "
"0","  if (total_missing > 0) {"
"0","    cat(sprintf(""→ Performing MICE imputation for %d remaining missing values...\n"", total_missing))"
"0","    "
"0","    mice_data <- clustering_data[, good_vars_for_clustering, with = FALSE]"
"0","    mice_df <- as.data.frame(mice_data)"
"0","    "
"0","    for (col_name in names(mice_df)) {"
"0","      if (inherits(mice_df[[col_name]], ""haven_labelled"")) {"
"0","        mice_df[[col_name]] <- as.numeric(mice_df[[col_name]])"
"0","      }"
"0","    }"
"0","    "
"0","    mice_methods <- mice::make.method(mice_df)"
"0","    for (var in names(mice_df)) {"
"0","      if (is.factor(mice_df[[var]])) {"
"0","        n_levels <- length(levels(mice_df[[var]]))"
"0","        if (n_levels == 2) {"
"0","          mice_methods[var] <- ""logreg"""
"0","        } else if (n_levels > 2) {"
"0","          mice_methods[var] <- ""polyreg"""
"0","        }"
"0","      } else if (is.numeric(mice_df[[var]])) {"
"0","        mice_methods[var] <- ""pmm"""
"0","      }"
"0","    }"
"0","    "
"0","    tryCatch({"
"0","      mice_result <- mice::mice(mice_df, m = mice_iterations, method = mice_methods,"
"0","                                printFlag = FALSE, seed = 42)"
"0","      completed_mice_df <- mice::complete(mice_result, 1)"
"0","      completed_mice_dt <- setDT(completed_mice_df)"
"0","      "
"0","      for (var in good_vars_for_clustering) {"
"0","        clustering_data[[var]] <- completed_mice_dt[[var]]"
"0","      }"
"0","      "
"0","      cat(""✓ MICE imputation completed successfully\n"")"
"0","      "
"0","    }, error = function(e) {"
"0","      cat(sprintf(""⚠ MICE imputation failed: %s\n"", e$message))"
"0","    })"
"0","    "
"0","  } else {"
"0","    cat(""✓ No missing values detected\n"")"
"0","  }"
"0","  "
"0","  initial_n <- nrow(clustering_data)"
"0","  essential_missing <- rowSums(is.na(clustering_data[, available_essential, with = FALSE]))"
"0","  clustering_data <- clustering_data[essential_missing == 0]"
"0","  final_n <- nrow(clustering_data)"
"0","  "
"0","  if (final_n < initial_n) {"
"0","    cat(sprintf(""⚠ Removed %d cases with missing essential variables\n"", initial_n - final_n))"
"0","  }"
"0","  "
"0","  cat(sprintf(""✓ Final dataset: %d students (%.1f%% retention)\n"","
"0","              final_n, 100 * final_n / initial_n))"
"0","  "
"0","  if (""W_FSTUWT"" %in% names(clustering_data)) {"
"0","    clustering_data[, W_FSTUWT_NORM := W_FSTUWT / mean(W_FSTUWT, na.rm = TRUE)]"
"0","  }"
"0","  "
"0","  return(list("
"0","    data = clustering_data,"
"0","    clustering_vars = good_vars_for_clustering,"
"0","    categorical_vars = available_categorical,"
"0","    continuous_vars = continuous_vars,"
"0","    cycle = cycle_name,"
"0","    essential_vars = available_essential"
"0","  ))"
"0","}"
"0",""
"0","cycle_prepared_data <- list()"
"0","for (cycle_name in names(processed_list)) {"
"0","  if (!is.null(processed_list[[cycle_name]])) {"
"0","    cycle_vars <- cycle_variable_analysis[[cycle_name]]$clustering_vars"
"0","    cycle_prepared_data[[cycle_name]] <- prepare_clustering_data("
"0","      processed_list[[cycle_name]]$data, cycle_vars, cycle_name"
"0","    )"
"0","  }"
"0","}"
"1","→ Preparing clustering dataset for PISA 2015...
"
"1","→ Analyzing missing value patterns...
"
"1","⚠ Dropped 1 variables with >30% missingness
"
"1","→ Performing MICE imputation for 724 remaining missing values...
"
"1","✓ MICE imputation completed successfully
"
"1","✓ Final dataset: 1373 students (100.0% retention)
"
"1","→ Preparing clustering dataset for PISA 2018...
"
"1","→ Analyzing missing value patterns...
"
"1","⚠ Dropped 3 variables with >30% missingness
"
"1","→ Performing MICE imputation for 1671 remaining missing values...
"
"1","✓ MICE imputation completed successfully
"
"1","✓ Final dataset: 1593 students (100.0% retention)
"
"1","→ Preparing clustering dataset for PISA 2022...
"
"1","→ Analyzing missing value patterns...
"
"1","⚠ Dropped 9 variables with >30% missingness
"
"1","→ Performing MICE imputation for 3249 remaining missing values...
"
"1","✓ MICE imputation completed successfully
"
"1","✓ Final dataset: 1579 students (100.0% retention)
"
"0","cat(""\n✓ Data preparation completed for all cycles\n"")"
"1","
✓ Data preparation completed for all cycles
"
