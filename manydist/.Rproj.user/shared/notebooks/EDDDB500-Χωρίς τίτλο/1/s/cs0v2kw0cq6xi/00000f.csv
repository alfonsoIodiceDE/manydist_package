"0","cat(""\\n=== CROSS-CYCLE STABILITY ANALYSIS ===\\n"")"
"1","\n=== CROSS-CYCLE STABILITY ANALYSIS ===\n"
"0","# Analyze clustering stability across PISA cycles"
"0","if (""CYCLE"" %in% names(clustering_data) && length(unique(clustering_data$CYCLE)) > 1) {"
"0","  "
"0","  analyze_cross_cycle_stability <- function(analysis_result, clustering_type) {"
"0","    "
"0","    cat(sprintf(""\\n--- %s Clustering Stability Across Cycles ---\\n"", "
"0","                tools::toTitleCase(clustering_type)))"
"0","    "
"0","    data_with_clusters <- analysis_result$data"
"0","    "
"0","    # Cluster distribution by cycle"
"0","    cycle_cluster_dist <- data_with_clusters[, .N, by = .(CYCLE, cluster)]"
"0","    cycle_cluster_wide <- dcast(cycle_cluster_dist, CYCLE ~ cluster, value.var = ""N"", fill = 0)"
"0","    "
"0","    cat(""Cluster distribution by PISA cycle:\\n"")"
"0","    print(cycle_cluster_wide)"
"0","    "
"0","    # Calculate chi-square test for independence"
"0","    if (nrow(cycle_cluster_wide) > 1 && ncol(cycle_cluster_wide) > 2) {"
"0","      cluster_cols <- names(cycle_cluster_wide)[names(cycle_cluster_wide) != ""CYCLE""]"
"0","      contingency_matrix <- as.matrix(cycle_cluster_wide[, cluster_cols, with = FALSE])"
"0","      "
"0","      chi_test <- chisq.test(contingency_matrix)"
"0","      cat(sprintf(""\\nChi-square test for cycle-cluster independence:\\n""))"
"0","      cat(sprintf(""  χ² = %.3f, df = %d, p-value = %.3f\\n"", "
"0","                  chi_test$statistic, chi_test$parameter, chi_test$p.value))"
"0","      "
"0","      if (chi_test$p.value < 0.05) {"
"0","        cat(""  → Significant difference in cluster distribution across cycles\\n"")"
"0","      } else {"
"0","        cat(""  → No significant difference in cluster distribution across cycles\\n"")"
"0","      }"
"0","    }"
"0","    "
"0","    # Resilience rate stability by cluster across cycles"
"0","    if (""RESILIENT"" %in% names(data_with_clusters)) {"
"0","      resilience_stability <- data_with_clusters[, .("
"0","        resilience_rate = mean(RESILIENT, na.rm = TRUE),"
"0","        n_students = .N"
"0","      ), by = .(CYCLE, cluster)]"
"0","      "
"0","      cat(sprintf(""\\nResilience rate stability by cluster:\\n""))"
"0","      resilience_wide <- dcast(resilience_stability, cluster ~ CYCLE, "
"0","                               value.var = ""resilience_rate"")"
"0","      print(resilience_wide)"
"0","      "
"0","      # Calculate coefficient of variation for resilience rates"
"0","      resilience_stability_summary <- resilience_stability[, .("
"0","        mean_resilience = mean(resilience_rate),"
"0","        sd_resilience = sd(resilience_rate),"
"0","        cv_resilience = sd(resilience_rate) / mean(resilience_rate)"
"0","      ), by = cluster]"
"0","      "
"0","      cat(sprintf(""\\nResilience rate stability (lower CV = more stable):\\n""))"
"0","      print(resilience_stability_summary)"
"0","    }"
"0","    "
"0","    return(list("
"0","      cycle_distribution = cycle_cluster_wide,"
"0","      resilience_stability = if (exists(""resilience_stability"")) resilience_stability else NULL"
"0","    ))"
"0","  }"
"0","  "
"0","  # Analyze stability for both optimal clusterings"
"0","  macro_stability <- analyze_cross_cycle_stability(optimal_macro_analysis, ""macro"")"
"0","  micro_stability <- analyze_cross_cycle_stability(optimal_micro_analysis, ""micro"")"
"0","  "
"0","} else {"
"0","  cat(""⚠ Cross-cycle analysis not possible: insufficient cycle data\\n"")"
"0","}"
"1","\n--- Macro Clustering Stability Across Cycles ---\n"
"1","Cluster distribution by PISA cycle:\n"
