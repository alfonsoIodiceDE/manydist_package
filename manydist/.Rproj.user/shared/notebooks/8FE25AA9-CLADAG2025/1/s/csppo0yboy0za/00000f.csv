"0","# ---- Enhanced File Reading with Variable Mapping ----"
"0","safe_read_pisa_with_mapping <- function(file_path, var_list, var_mapping,"
"0","                                        target_countries = NULL, cycle_year = NULL) {"
"0","  tryCatch({"
"0","    file_vars <- names(read_sav(file_path, n_max = 0))"
"0","    reverse_mapping <- setNames(names(var_mapping), var_mapping)"
"0","    vars_to_request <- sapply(var_list, function(std_var) {"
"0","      if (std_var %in% names(reverse_mapping)) {"
"0","        reverse_mapping[[std_var]]"
"0","      } else {"
"0","        std_var"
"0","      }"
"0","    })"
"0","    available_vars <- intersect(vars_to_request, file_vars)"
"0","    if (length(available_vars) == 0) {"
"0","      warning(""No requested variables found in "", basename(file_path))"
"0","      return(NULL)"
"0","    }"
"0","    dt <- setDT(read_sav(file_path, col_select = any_of(available_vars)))"
"0","    for (old_name in names(var_mapping)) {"
"0","      new_name <- var_mapping[[old_name]]"
"0","      if (old_name %in% names(dt)) {"
"0","        setnames(dt, old_name, new_name)"
"0","      }"
"0","    }"
"0","    if (!is.null(target_countries) && ""CNT"" %in% names(dt)) {"
"0","      dt <- dt[CNT %in% target_countries]"
"0","    }"
"0","    if (!is.null(cycle_year)) {"
"0","      dt[, CYCLE := cycle_year]"
"0","    }"
"0","    std_names_loaded <- names(dt)[names(dt) %in% var_list]"
"0","    missing_vars <- setdiff(var_list, std_names_loaded)"
"0","    if (length(missing_vars) > 0) {"
"0","      cat(""Cycle"", cycle_year, ""- Missing variables:"","
"0","          paste(missing_vars, collapse = "", ""), ""\n"")"
"0","    }"
"0","    return(dt)"
"0","  }, error = function(e) {"
"0","    cat(""Error reading file:"", basename(file_path), ""\n"")"
"0","    cat(""Error message:"", e$message, ""\n"")"
"0","    return(NULL)"
"0","  })"
"0","}"
