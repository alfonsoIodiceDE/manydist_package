"0","cat(""\n=== ENHANCED CYCLE-SPECIFIC VARIABLE SELECTION ===\n"")"
"1","
=== ENHANCED CYCLE-SPECIFIC VARIABLE SELECTION ===
"
"0","# Function to comprehensively analyze and select variables for each cycle"
"0","identify_cycle_variables_enhanced <- function(cycle_data, cycle_name) {"
"0","  "
"0","  cat(sprintf(""→ Comprehensive variable analysis for PISA %s...\n"", cycle_name))"
"0","  "
"0","  # Get all available variables"
"0","  all_available_vars <- names(cycle_data)"
"0","  cat(sprintf(""  Total variables in dataset: %d\n"", length(all_available_vars)))"
"0","  "
"0","  # Core resilience variables (must have)"
"0","  core_vars <- c(""MATH_AVG"", ""READ_AVG"", ""SCIE_AVG"", ""ESCS"", ""RESILIENT"")"
"0","  "
"0","  # Comprehensive extended variable categories with more flexible patterns"
"0","  extended_vars <- list("
"0","    "
"0","    # Socioeconomic background"
"0","    ses_background = c(""HISEI"", ""PAREDINT"", ""HOMEPOS"", ""ICTRES"", ""CULTPOSS"", ""HEDRES""),"
"0","    "
"0","    # Demographics (basic student characteristics)"
"0","    demographics = c(""ST004D01T"", ""GRADE"", ""IMMIG"", ""REPEAT"", ""LANGN"", ""PRESCHOOL"", "
"0","                     ""ST005Q01TA"", ""ST003D02T"", ""ST003D03T""),"
"0","    "
"0","    # Academic motivation and attitudes"
"0","    motivation = c(""ANXMAT"", ""MATHMOT"", ""MATHEFF"", ""SCIEEFF"", ""JOYSCIE"", ""INTMAT"","
"0","                   ""GRWTHMND"", ""WORKMAST"", ""RESILIENCE"", ""MASTGOAL"", ""GFOFAIL"", ""COMPETE"","
"0","                   ""SWBP"", ""MOTIVAT"", ""CONFID""),"
"0","    "
"0","    # Learning behaviors and study habits"
"0","    learning_behavior = c(""PERSEV"", ""TRUANCY"", ""HOMWRK"", ""DISCLIMA"", ""DIRINS"", "
"0","                          ""PERFEED"", ""OUTHOURS"", ""STUDYEFF"", ""METASUM"", ""METACOG""),"
"0","    "
"0","    # Social-emotional factors"
"0","    social_emotional = c(""BELONG"", ""TEACHSUP"", ""PEERREL"", ""BULLIED"", ""FAMSUP"", ""RELATST"", "
"0","                         ""EMOSUPS"", ""PERCOMP"", ""PERCOOP"", ""TEACHINT"", ""STUREL"", ""SWBP""),"
"0","    "
"0","    # Well-being and life satisfaction"
"0","    wellbeing = c(""LIFESAT"", ""EUDMO"", ""WELLBEING"", ""ATTSCHL"", ""EXPDEG"", ""PHYSACT"", "
"0","                  ""SCHWELL"", ""JOYREAD"", ""WORRYSCH""),"
"0","    "
"0","    # School context and environment"
"0","    school_context = c(""SCHSIZE"", ""SCHLTYPE"", ""STRATIO"", ""STAFFSHORT"", ""EDUSHORT"", "
"0","                       ""RATCMP1"", ""PROPCERT"", ""PROPQUAL"", ""TCSHORT""),"
"0","    "
"0","    # Technology and ICT"
"0","    ict_usage = c(""USESCH"", ""USEHOME"", ""ICTSCHOOL"", ""ICTOUTSIDE"", ""ICTCLASS""),"
"0","    "
"0","    # Additional potential variables (pattern matching)"
"0","    pattern_based = character(0)  # Will be filled by pattern matching"
"0","  )"
"0","  "
"0","  # Pattern-based variable discovery for cycle-specific variables"
"0","  # Look for variables that might be relevant but not in our predefined lists"
"0","  "
"0","  # Learning and cognitive patterns"
"0","  learning_patterns <- c(""LEARN"", ""STUDY"", ""COGN"", ""META"", ""THINK"", ""REASON"")"
"0","  motivation_patterns <- c(""MOTIV"", ""ANXIE"", ""CONF"", ""ENJOY"", ""LIKE"", ""INTER"")"
"0","  social_patterns <- c(""PEER"", ""FRIEND"", ""SOCIAL"", ""COOP"", ""COMP"", ""HELP"")"
"0","  wellbeing_patterns <- c(""WELL"", ""LIFE"", ""HAPPY"", ""STRESS"", ""WORRY"", ""FEEL"")"
"0","  "
"0","  # Find variables matching patterns"
"0","  pattern_vars <- character(0)"
"0","  for (pattern in c(learning_patterns, motivation_patterns, social_patterns, wellbeing_patterns)) {"
"0","    pattern_matches <- all_available_vars[grepl(pattern, all_available_vars, ignore.case = TRUE)]"
"0","    pattern_vars <- c(pattern_vars, pattern_matches)"
"0","  }"
"0","  "
"0","  # Remove system variables and IDs from pattern matches"
"0","  exclude_patterns <- c(""^PV[0-9]"", ""^W_"", ""^CNT"", ""ID$"", ""^ST00[0-9]Q[0-9][0-9]"", ""FLAG"", ""ADMIN"")"
"0","  for (exclude_pattern in exclude_patterns) {"
"0","    pattern_vars <- pattern_vars[!grepl(exclude_pattern, pattern_vars)]"
"0","  }"
"0","  "
"0","  extended_vars$pattern_based <- unique(pattern_vars)"
"0","  "
"0","  # Check availability and coverage for each category"
"0","  available_vars <- all_available_vars"
"0","  cycle_clustering_vars <- core_vars[core_vars %in% available_vars]"
"0","  "
"0","  category_summary <- list()"
"0","  "
"0","  cat(""\n  Category analysis:\n"")"
"0","  "
"0","  for (category in names(extended_vars)) {"
"0","    category_vars <- extended_vars[[category]]"
"0","    available_category_vars <- intersect(category_vars, available_vars)"
"0","    "
"0","    category_summary[[category]] <- list("
"0","      total = length(category_vars),"
"0","      available = length(available_category_vars),"
"0","      variables = available_category_vars,"
"0","      coverage = if(length(category_vars) > 0) length(available_category_vars) / length(category_vars) else 0"
"0","    )"
"0","    "
"0","    # More flexible inclusion criteria"
"0","    include_category <- FALSE"
"0","    "
"0","    if (category == ""pattern_based"") {"
"0","      # Include pattern-based variables if we found any"
"0","      include_category <- length(available_category_vars) > 0"
"0","    } else {"
"0","      # For predefined categories, use lower threshold (30% instead of 50%)"
"0","      include_category <- category_summary[[category]]$coverage >= 0.3"
"0","    }"
"0","    "
"0","    if (include_category) {"
"0","      cycle_clustering_vars <- c(cycle_clustering_vars, available_category_vars)"
"0","      status_symbol <- ""✓"""
"0","    } else {"
"0","      status_symbol <- ""✗"""
"0","    }"
"0","    "
"0","    cat(sprintf(""    %s %s: %d/%d variables (%.1f%% coverage)\n"", "
"0","                status_symbol, category, "
"0","                length(available_category_vars), length(category_vars),"
"0","                category_summary[[category]]$coverage * 100))"
"0","    "
"0","    # Show some example variables for each category"
"0","    if (length(available_category_vars) > 0) {"
"0","      example_vars <- head(available_category_vars, 3)"
"0","      cat(sprintf(""      Examples: %s\n"", paste(example_vars, collapse = "", "")))"
"0","    }"
"0","  }"
"0","  "
"0","  # Remove duplicates"
"0","  cycle_clustering_vars <- unique(cycle_clustering_vars)"
"0","  "
"0","  # Additional comprehensive variable discovery"
"0","  cat(""\n  → Searching for additional educational variables...\n"")"
"0","  "
"0","  # Look for any remaining educational/psychological variables"
"0","  educational_keywords <- c(""TEACH"", ""CLASS"", ""INSTRU"", ""CURRIC"", ""ASSESS"", ""FEEDB"","
"0","                           ""ATTITUD"", ""BELIE"", ""PERCE"", ""EXPEC"", ""GOAL"", ""STRAT"")"
"0","  "
"0","  additional_vars <- character(0)"
"0","  for (keyword in educational_keywords) {"
"0","    keyword_matches <- all_available_vars[grepl(keyword, all_available_vars, ignore.case = TRUE)]"
"0","    # Filter out system variables"
"0","    keyword_matches <- keyword_matches[!grepl(""^PV[0-9]|^W_|^CNT|ID$|FLAG|ADMIN"", keyword_matches)]"
"0","    additional_vars <- c(additional_vars, keyword_matches)"
"0","  }"
"0","  "
"0","  # Add variables not already included"
"0","  new_additional_vars <- setdiff(additional_vars, cycle_clustering_vars)"
"0","  if (length(new_additional_vars) > 0) {"
"0","    cycle_clustering_vars <- c(cycle_clustering_vars, new_additional_vars)"
"0","    cat(sprintf(""  → Found %d additional educational variables\n"", length(new_additional_vars)))"
"0","    cat(sprintf(""      Examples: %s\n"", paste(head(new_additional_vars, 5), collapse = "", "")))"
"0","  }"
"0","  "
"0","  # Final deduplication"
"0","  cycle_clustering_vars <- unique(cycle_clustering_vars)"
"0","  "
"0","  # Remove any system/ID variables that might have slipped through"
"0","  final_exclude_pattern <- ""^(PV[0-9]|W_|CNT|.*ID$|.*FLAG|.*ADMIN)"""
"0","  cycle_clustering_vars <- cycle_clustering_vars[!grepl(final_exclude_pattern, cycle_clustering_vars)]"
"0","  "
"0","  cat(sprintf(""\n✓ Selected %d clustering variables for PISA %s\n"", "
"0","              length(cycle_clustering_vars), cycle_name))"
"0","  "
"0","  # Show variable breakdown by type"
"0","  suspected_categorical <- cycle_clustering_vars[grepl(""^ST[0-9].*Q[0-9]|GRADE|IMMIG|REPEAT|SCHLTYPE"", cycle_clustering_vars)]"
"0","  suspected_continuous <- setdiff(cycle_clustering_vars, suspected_categorical)"
"0","  "
"0","  cat(sprintf(""  → Estimated: %d continuous, %d categorical\n"", "
"0","              length(suspected_continuous), length(suspected_categorical)))"
"0","  "
"0","  return(list("
"0","    clustering_vars = cycle_clustering_vars,"
"0","    category_summary = category_summary,"
"0","    suspected_categorical = suspected_categorical,"
"0","    suspected_continuous = suspected_continuous,"
"0","    total_available = length(all_available_vars)"
"0","  ))"
"0","}"
"0",""
"0","# Enhanced analysis for each cycle"
"0","cycle_variable_analysis <- list()"
"0",""
"0","for (cycle_name in names(processed_list)) {"
"0","  if (!is.null(processed_list[[cycle_name]])) {"
"0","    cycle_variable_analysis[[cycle_name]] <- identify_cycle_variables_enhanced("
"0","      processed_list[[cycle_name]], cycle_name"
"0","    )"
"0","  }"
"0","}"
"1","→ Comprehensive variable analysis for PISA 2015...
"
"1","  Total variables in dataset: 66
"
"1","
  Category analysis:
"
"1","    ✓ ses_background: 4/6 variables (66.7% coverage)
"
"1","      Examples: HISEI, PAREDINT, HOMEPOS
"
"1","    ✓ demographics: 5/9 variables (55.6% coverage)
"
"1","      Examples: ST004D01T, GRADE, IMMIG
"
"1","    ✗ motivation: 4/15 variables (26.7% coverage)
"
"1","      Examples: ANXMAT, MATHMOT, SCIEEFF
"
"1","    ✗ learning_behavior: 2/10 variables (20.0% coverage)
"
"1","      Examples: PERFEED, OUTHOURS
"
"1","    ✗ social_emotional: 3/12 variables (25.0% coverage)
"
"1","      Examples: BELONG, TEACHSUP, EMOSUPS
"
"1","    ✗ wellbeing: 0/9 variables (0.0% coverage)
"
"1","    ✓ school_context: 6/9 variables (66.7% coverage)
"
"1","      Examples: SCHSIZE, SCHLTYPE, STRATIO
"
"1","    ✗ ict_usage: 0/5 variables (0.0% coverage)
"
"1","    ✗ pattern_based: 0/0 variables (0.0% coverage)
"
"1","
  → Searching for additional educational variables...
"
"1","  → Found 1 additional educational variables
"
"1","      Examples: TEACHSUP
"
"1","
✓ Selected 21 clustering variables for PISA 2015
"
"1","  → Estimated: 17 continuous, 4 categorical
"
"1","→ Comprehensive variable analysis for PISA 2018...
"
"1","  Total variables in dataset: 72
"
"1","
  Category analysis:
"
"1","    ✓ ses_background: 4/6 variables (66.7% coverage)
"
"1","      Examples: HISEI, PAREDINT, HOMEPOS
"
"1","    ✓ demographics: 5/9 variables (55.6% coverage)
"
"1","      Examples: ST004D01T, GRADE, IMMIG
"
"1","    ✓ motivation: 5/15 variables (33.3% coverage)
"
"1","      Examples: WORKMAST, RESILIENCE, MASTGOAL
"
"1","    ✓ learning_behavior: 3/10 variables (30.0% coverage)
"
"1","      Examples: DISCLIMA, DIRINS, PERFEED
"
"1","    ✓ social_emotional: 6/12 variables (50.0% coverage)
"
"1","      Examples: BELONG, TEACHSUP, EMOSUPS
"
"1","    ✗ wellbeing: 1/9 variables (11.1% coverage)
"
"1","      Examples: EUDMO
"
"1","    ✓ school_context: 6/9 variables (66.7% coverage)
"
"1","      Examples: SCHSIZE, SCHLTYPE, STRATIO
"
"1","    ✗ ict_usage: 0/5 variables (0.0% coverage)
"
"1","    ✓ pattern_based: 3/3 variables (100.0% coverage)
"
"1","      Examples: PERCOOP, PERCOMP, COMPETE
"
"1","
  → Searching for additional educational variables...
"
"1","
✓ Selected 34 clustering variables for PISA 2018
"
"1","  → Estimated: 30 continuous, 4 categorical
"
"1","→ Comprehensive variable analysis for PISA 2022...
"
"1","  Total variables in dataset: 66
"
"1","
  Category analysis:
"
"1","    ✓ ses_background: 4/6 variables (66.7% coverage)
"
"1","      Examples: HISEI, PAREDINT, HOMEPOS
"
"1","    ✓ demographics: 5/9 variables (55.6% coverage)
"
"1","      Examples: ST004D01T, GRADE, IMMIG
"
"1","    ✗ motivation: 3/15 variables (20.0% coverage)
"
"1","      Examples: ANXMAT, MATHMOT, MATHEFF
"
"1","    ✗ learning_behavior: 0/10 variables (0.0% coverage)
"
"1","    ✓ social_emotional: 5/12 variables (41.7% coverage)
"
"1","      Examples: BELONG, TEACHSUP, BULLIED
"
"1","    ✗ wellbeing: 1/9 variables (11.1% coverage)
"
"1","      Examples: LIFESAT
"
"1","    ✓ school_context: 6/9 variables (66.7% coverage)
"
"1","      Examples: SCHSIZE, SCHLTYPE, STRATIO
"
"1","    ✗ ict_usage: 0/5 variables (0.0% coverage)
"
"1","    ✓ pattern_based: 1/1 variables (100.0% coverage)
"
"1","      Examples: LIFESAT
"
"1","
  → Searching for additional educational variables...
"
"1","
✓ Selected 26 clustering variables for PISA 2022
"
"1","  → Estimated: 22 continuous, 4 categorical
"
"0","cat(""\n✓ Enhanced variable analysis completed for all cycles\n"")"
"1","
✓ Enhanced variable analysis completed for all cycles
"
"0","# Detailed comparison across cycles"
"0","cat(""\n=== CROSS-CYCLE VARIABLE COMPARISON ===\n"")"
"1","
=== CROSS-CYCLE VARIABLE COMPARISON ===
"
"0","all_unique_vars <- unique(unlist(lapply(cycle_variable_analysis, function(x) x$clustering_vars)))"
"0","cat(sprintf(""Total unique clustering variables across all cycles: %d\n\n"", length(all_unique_vars)))"
"1","Total unique clustering variables across all cycles: 38

"
"0","# Create variable availability matrix"
"0","cycle_names <- names(cycle_variable_analysis)"
"0","var_matrix <- matrix(FALSE, nrow = length(all_unique_vars), ncol = length(cycle_names))"
"0","rownames(var_matrix) <- all_unique_vars"
"0","colnames(var_matrix) <- cycle_names"
"0",""
"0","for (i in seq_along(cycle_names)) {"
"0","  cycle_vars <- cycle_variable_analysis[[cycle_names[i]]]$clustering_vars"
"0","  var_matrix[cycle_vars, i] <- TRUE"
"0","}"
"0",""
"0","# Summary statistics"
"0","cat(""Variables available by cycle:\n"")"
"1","Variables available by cycle:
"
"0","for (cycle_name in cycle_names) {"
"0","  n_vars <- sum(var_matrix[, cycle_name])"
"0","  cat(sprintf(""  %s: %d variables\n"", cycle_name, n_vars))"
"0","}"
"1","  2015: 21 variables
"
"1","  2018: 34 variables
"
"1","  2022: 26 variables
"
"0","# Variables common to all cycles"
"0","common_vars <- all_unique_vars[rowSums(var_matrix) == length(cycle_names)]"
"0","cat(sprintf(""\nVariables common to all cycles: %d\n"", length(common_vars)))"
"1","
Variables common to all cycles: 21
"
"0","if (length(common_vars) <= 10) {"
"0","  cat(""  Common variables:"", paste(common_vars, collapse = "", ""), ""\n"")"
"0","} else {"
"0","  cat(""  Common variables (first 10):"", paste(head(common_vars, 10), collapse = "", ""), ""\n"")"
"0","}"
"1","  Common variables (first 10):"
"1"," "
"1","MATH_AVG, READ_AVG, SCIE_AVG, ESCS, RESILIENT, HISEI, PAREDINT, HOMEPOS, ICTRES, ST004D01T"
"1"," "
"1","
"
"0","# Cycle-specific variables"
"0","cat(""\nCycle-specific variables:\n"")"
"1","
Cycle-specific variables:
"
"0","for (cycle_name in cycle_names) {"
"0","  cycle_specific <- all_unique_vars[var_matrix[, cycle_name] & rowSums(var_matrix) == 1]"
"0","  cat(sprintf(""  %s only: %d variables"", cycle_name, length(cycle_specific)))"
"0","  if (length(cycle_specific) > 0) {"
"0","    cat(sprintf("" (e.g., %s)"", paste(head(cycle_specific, 3), collapse = "", "")))"
"0","  }"
"0","  cat(""\n"")"
"0","}"
"1","  2015 only: 0 variables"
"1","
"
"1","  2018 only: 12 variables"
"1"," (e.g., WORKMAST, RESILIENCE, MASTGOAL)"
"1","
"
"1","  2022 only: 4 variables"
"1"," (e.g., BULLIED, FAMSUP, RELATST)"
"1","
"
"0","cat(""\n✓ Cross-cycle variable comparison completed\n"")"
"1","
✓ Cross-cycle variable comparison completed
"
