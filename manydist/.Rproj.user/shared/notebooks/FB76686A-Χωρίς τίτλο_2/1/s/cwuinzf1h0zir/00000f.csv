"0","cat(""\n=== LOADING AND PROCESSING PISA DATA ===\n"")"
"1","
=== LOADING AND PROCESSING PISA DATA ===
"
"0","# ---- PISA Cycle Configuration ----"
"0","pisa_cycles <- list("
"0","  ""2015"" = list("
"0","    student_file = ""CY6_MS_CMB_STU_QQQ.sav"","
"0","    school_file = ""CY6_MS_CMB_SCH_QQQ.sav"","
"0","    year = 2015,"
"0","    var_mapping = list("
"0","      student = c("
"0","        ""hisei"" = ""HISEI"","
"0","        ""PARED"" = ""PAREDINT"","
"0","        ""ANXTEST"" = ""ANXMAT"","
"0","        ""MOTIVAT"" = ""MATHMOT"""
"0","      ),"
"0","      school = c("
"0","        ""STRATIO"" = ""STRATIO"""
"0","      )"
"0","    )"
"0","  ),"
"0","  ""2018"" = list("
"0","    student_file = ""CY07_MSU_STU_QQQ.sav"","
"0","    school_file = ""CY07_MSU_SCH_QQQ.sav"","
"0","    year = 2018,"
"0","    var_mapping = list("
"0","      student = c(),"
"0","      school = c("
"0","        ""STRATIO"" = ""STRATIO"""
"0","      )"
"0","    )"
"0","  ),"
"0","  ""2022"" = list("
"0","    student_file = ""CY08MSP_STU_QQQ.sav"","
"0","    school_file = ""CY08MSP_SCH_QQQ.sav"","
"0","    year = 2022,"
"0","    var_mapping = list("
"0","      student = c(),"
"0","      school = c("
"0","        ""SMRATIO"" = ""STRATIO"""
"0","      )"
"0","    )"
"0","  )"
"0",")"
"0",""
"0","# ---- Core Variable Lists ----"
"0","core_student_vars <- list("
"0","  ids = c(""CNT"", ""CNTSCHID"", ""CNTSTUID""),"
"0","  achievement = c("
"0","    paste0(""PV"", 1:10, ""MATH""),"
"0","    paste0(""PV"", 1:10, ""READ""),"
"0","    paste0(""PV"", 1:10, ""SCIE"")"
"0","  ),"
"0","  ses_background = c("
"0","    ""ESCS"", ""HISEI"", ""PAREDINT"", ""HOMEPOS"", ""ICTRES"""
"0","  ),"
"0","  demographics = c("
"0","    ""ST004D01T"", ""GRADE"", ""IMMIG"", ""REPEAT"", ""LANGN"""
"0","  ),"
"0","  motivation = c("
"0","    ""ANXMAT"", ""MATHMOT"", ""MATHEFF"", ""SCIEEFF"", ""JOYSCIE"", ""INTMAT"","
"0","    ""GRWTHMND"", ""WORKMAST"", ""RESILIENCE"", ""MASTGOAL"", ""GFOFAIL"", ""COMPETE"""
"0","  ),"
"0","  behavior = c("
"0","    ""PERSEV"", ""TRUANCY"", ""HOMWRK"", ""DISCLIMA"", ""DIRINS"", ""PERFEED"", ""OUTHOURS"""
"0","  ),"
"0","  social_emotional = c("
"0","    ""BELONG"", ""TEACHSUP"", ""PEERREL"", ""BULLIED"", ""FAMSUP"", ""RELATST"", "
"0","    ""EMOSUPS"", ""PERCOMP"", ""PERCOOP"", ""TEACHINT"""
"0","  ),"
"0","  resilience_other = c("
"0","    ""LIFESAT"", ""EUDMO"", ""WELLBEING"", ""ATTSCHL"", ""EXPDEG"", ""PHYSACT"", ""SCHWELL"""
"0","  ),"
"0","  weights = ""W_FSTUWT"""
"0",")"
"0",""
"0","core_school_vars <- list("
"0","  ids = c(""CNT"", ""CNTSCHID""),"
"0","  characteristics = c("
"0","    ""SCHSIZE"", ""SCHLTYPE"", ""STRATIO"""
"0","  ),"
"0","  resources = c("
"0","    ""STAFFSHORT"", ""EDUSHORT"", ""RATCMP1"""
"0","  ),"
"0","  weights = ""W_SCHGRNRABWT"""
"0",")"
"0",""
"0","# ---- File Reading Function ----"
"0","safe_read_pisa_with_mapping <- function(file_path, var_list, var_mapping,"
"0","                                        target_countries = NULL, cycle_year = NULL) {"
"0","  tryCatch({"
"0","    file_vars <- names(read_sav(file_path, n_max = 0))"
"0","    reverse_mapping <- setNames(names(var_mapping), var_mapping)"
"0","    vars_to_request <- sapply(var_list, function(std_var) {"
"0","      if (std_var %in% names(reverse_mapping)) {"
"0","        reverse_mapping[[std_var]]"
"0","      } else {"
"0","        std_var"
"0","      }"
"0","    })"
"0","    available_vars <- intersect(vars_to_request, file_vars)"
"0","    if (length(available_vars) == 0) {"
"0","      warning(""No requested variables found in "", basename(file_path))"
"0","      return(NULL)"
"0","    }"
"0","    dt <- setDT(read_sav(file_path, col_select = any_of(available_vars)))"
"0","    for (old_name in names(var_mapping)) {"
"0","      new_name <- var_mapping[[old_name]]"
"0","      if (old_name %in% names(dt)) {"
"0","        setnames(dt, old_name, new_name)"
"0","      }"
"0","    }"
"0","    if (!is.null(target_countries) && ""CNT"" %in% names(dt)) {"
"0","      dt <- dt[CNT %in% target_countries]"
"0","    }"
"0","    if (!is.null(cycle_year)) {"
"0","      dt[, CYCLE := cycle_year]"
"0","    }"
"0","    return(dt)"
"0","  }, error = function(e) {"
"0","    cat(""Error reading file:"", basename(file_path), ""\n"")"
"0","    return(NULL)"
"0","  })"
"0","}"
"0",""
"0","# ---- Load All PISA Cycles ----"
"0","all_student_vars <- unlist(core_student_vars, use.names = FALSE)"
"0","all_school_vars <- unlist(core_school_vars, use.names = FALSE)"
"0","pisa_student_list <- list()"
"0","pisa_school_list <- list()"
"0",""
"0","for (cycle_name in names(pisa_cycles)) {"
"0","  cycle_info <- pisa_cycles[[cycle_name]]"
"0","  cat(""\n--- Loading PISA"", cycle_info$year, ""---\n"")"
"0","  "
"0","  stu_file <- path(cycle_info$student_file)"
"0","  stu_data <- safe_read_pisa_with_mapping("
"0","    stu_file, all_student_vars, cycle_info$var_mapping$student,"
"0","    target_countries, cycle_info$year"
"0","  )"
"0","  if (!is.null(stu_data) && nrow(stu_data) > 0) {"
"0","    pisa_student_list[[cycle_name]] <- stu_data"
"0","    cat(""Students loaded:"", nrow(stu_data), ""\n"")"
"0","  }"
"0","  "
"0","  sch_file <- path(cycle_info$school_file)"
"0","  sch_data <- safe_read_pisa_with_mapping("
"0","    sch_file, all_school_vars, cycle_info$var_mapping$school,"
"0","    target_countries, cycle_info$year"
"0","  )"
"0","  if (!is.null(sch_data) && nrow(sch_data) > 0) {"
"0","    pisa_school_list[[cycle_name]] <- sch_data"
"0","    cat(""Schools loaded:"", nrow(sch_data), ""\n"")"
"0","  }"
"0","}"
"1","
--- Loading PISA"
"1"," "
"1","2015"
"1"," "
"1","---
"
"1","Students loaded:"
"1"," "
"1","5532"
"1"," "
"1","
"
"1","Schools loaded:"
"1"," "
"1","211"
"1"," "
"1","
"
"1","
--- Loading PISA"
"1"," "
"1","2018"
"1"," "
"1","---
"
"1","Students loaded:"
"1"," "
"1","6403"
"1"," "
"1","
"
"1","Schools loaded:"
"1"," "
"1","242"
"1"," "
"1","
"
"1","
--- Loading PISA"
"1"," "
"1","2022"
"1"," "
"1","---
"
"1","Students loaded:"
"1"," "
"1","6403"
"1"," "
"1","
"
"1","Schools loaded:"
"1"," "
"1","230"
"1"," "
"1","
"
"0","# ---- Process PISA Cycle Function ----"
"0","process_pisa_cycle <- function(stu_dt, sch_dt, cycle_year) {"
"0","  if (is.null(stu_dt) || nrow(stu_dt) == 0) return(NULL)"
"0","  "
"0","  # Compute average achievement scores"
"0","  stu_dt[, MATH_AVG := rowMeans(.SD, na.rm = TRUE), .SDcols = patterns(""MATH$"")]"
"0","  stu_dt[, READ_AVG := rowMeans(.SD, na.rm = TRUE), .SDcols = patterns(""READ$"")]"
"0","  stu_dt[, SCIE_AVG := rowMeans(.SD, na.rm = TRUE), .SDcols = patterns(""SCIE$"")]"
"0","  "
"0","  # Identify disadvantaged students"
"0","  escs_quartile <- quantile(stu_dt$ESCS, probs = DISADVANTAGED_THRESHOLD, na.rm = TRUE)"
"0","  stu_dt[, DISADVANTAGED := ifelse(ESCS <= escs_quartile, 1, 0)]"
"0","  "
"0","  # Define resilience"
"0","  MATH_LEVEL3_THRESHOLD <- 482.38"
"0","  READ_LEVEL3_THRESHOLD <- 480.18"
"0","  SCIE_LEVEL3_THRESHOLD <- 484.14"
"0","  "
"0","  stu_dt[DISADVANTAGED == 1, RESILIENT := ifelse("
"0","    MATH_AVG >= MATH_LEVEL3_THRESHOLD & "
"0","      READ_AVG >= READ_LEVEL3_THRESHOLD & "
"0","      SCIE_AVG >= SCIE_LEVEL3_THRESHOLD, 1, 0)]"
"0","  "
"0","  # Filter to disadvantaged students"
"0","  disadv_dt <- stu_dt[DISADVANTAGED == 1]"
"0","  "
"0","  # Merge with school data"
"0","  if (!is.null(sch_dt) && nrow(sch_dt) > 0) {"
"0","    disadv_dt <- merge(disadv_dt, sch_dt, by = c(""CNT"", ""CNTSCHID"", ""CYCLE""), all.x = TRUE)"
"0","  }"
"0","  "
"0","  disadv_dt[is.na(RESILIENT), RESILIENT := 0]"
"0","  "
"0","  return(disadv_dt)"
"0","}"
"0",""
"0","# ---- Apply Processing ----"
"0","processed_list <- mapply(process_pisa_cycle, pisa_student_list, pisa_school_list, "
"0","                         names(pisa_cycles), SIMPLIFY = FALSE)"
"0",""
"0","cat(""\n=== DATA PROCESSING SUMMARY ===\n"")"
"1","
=== DATA PROCESSING SUMMARY ===
"
"0","for (cycle in names(processed_list)) {"
"0","  if (!is.null(processed_list[[cycle]])) {"
"0","    n_students <- nrow(processed_list[[cycle]])"
"0","    n_resilient <- sum(processed_list[[cycle]]$RESILIENT, na.rm = TRUE)"
"0","    resilience_rate <- round(n_resilient / n_students * 100, 1)"
"0","    "
"0","    cat(""- Cycle"", cycle, "":"", n_students, ""students,"", n_resilient, "
"0","        ""resilient ("", resilience_rate, ""%)\n"")"
"0","  }"
"0","}"
"1","- Cycle"
"1"," "
"1","2015"
"1"," "
"1",":"
"1"," "
"1","1373"
"1"," "
"1","students,"
"1"," "
"1","152"
"1"," "
"1","resilient ("
"1"," "
"1","11.1"
"1"," "
"1","%)
"
"1","- Cycle"
"1"," "
"1","2018"
"1"," "
"1",":"
"1"," "
"1","1593"
"1"," "
"1","students,"
"1"," "
"1","218"
"1"," "
"1","resilient ("
"1"," "
"1","13.7"
"1"," "
"1","%)
"
"1","- Cycle"
"1"," "
"1","2022"
"1"," "
"1",":"
"1"," "
"1","1579"
"1"," "
"1","students,"
"1"," "
"1","133"
"1"," "
"1","resilient ("
"1"," "
"1","8.4"
"1"," "
"1","%)
"
