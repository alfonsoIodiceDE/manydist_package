"0","cat(""\n=== CYCLE-SPECIFIC DATA PREPARATION ===\n"")"
"1","
=== CYCLE-SPECIFIC DATA PREPARATION ===
"
"0","# Enhanced data preparation function"
"0","prepare_cycle_clustering_data <- function(cycle_data, cycle_vars, cycle_name, min_complete_pct = 0.7) {"
"0","  "
"0","  cat(sprintf(""→ Preparing clustering dataset for PISA %s...\n"", cycle_name))"
"0","  "
"0","  # Essential columns"
"0","  essential_cols <- c(""RESILIENT"", ""CYCLE"", ""W_FSTUWT"", ""CNTSTUID"", ""CNTSCHID"")"
"0","  available_essential <- intersect(essential_cols, names(cycle_data))"
"0","  "
"0","  # Combine variables"
"0","  all_vars <- c(cycle_vars, available_essential)"
"0","  clustering_data <- cycle_data[, all_vars, with = FALSE]"
"0","  "
"0","  # Handle missing values"
"0","  missing_summary <- clustering_data[, lapply(.SD, function(x) sum(is.na(x))/length(x)), "
"0","                                     .SDcols = cycle_vars]"
"0","  "
"0","  # Keep variables with sufficient data"
"0","  good_vars <- names(missing_summary)[missing_summary < (1 - min_complete_pct)]"
"0","  "
"0","  if (length(good_vars) < length(cycle_vars)) {"
"0","    dropped_vars <- setdiff(cycle_vars, good_vars)"
"0","    cat(sprintf(""⚠ Dropped %d variables due to missingness\n"", length(dropped_vars)))"
"0","  }"
"0","  "
"0","  # Filter to good variables"
"0","  final_vars <- c(good_vars, available_essential)"
"0","  clustering_data <- clustering_data[, final_vars, with = FALSE]"
"0","  "
"0","  # Remove cases with too much missingness"
"0","  initial_n <- nrow(clustering_data)"
"0","  complete_pct <- rowSums(!is.na(clustering_data[, good_vars, with = FALSE])) / length(good_vars)"
"0","  clustering_data <- clustering_data[complete_pct >= min_complete_pct]"
"0","  "
"0","  cat(sprintf(""✓ Retained %d students (%.1f%%)\n"", "
"0","              nrow(clustering_data), 100 * nrow(clustering_data) / initial_n))"
"0","  "
"0","  # Identify variable types"
"0","  categorical_vars <- c(""ST004D01T"", ""GRADE"", ""IMMIG"", ""REPEAT"", ""LANGN"", ""SCHLTYPE"")"
"0","  available_categorical <- intersect(categorical_vars, good_vars)"
"0","  continuous_vars <- setdiff(good_vars, available_categorical)"
"0","  "
"0","  # Convert categorical variables to factors"
"0","  for (var in available_categorical) {"
"0","    if (var %in% names(clustering_data)) {"
"0","      clustering_data[[var]] <- as.factor(clustering_data[[var]])"
"0","    }"
"0","  }"
"0","  "
"0","  cat(sprintf(""✓ Variable types: %d continuous, %d categorical\n"", "
"0","              length(continuous_vars), length(available_categorical)))"
"0","  "
"0","  return(list("
"0","    data = clustering_data,"
"0","    clustering_vars = good_vars,"
"0","    categorical_vars = available_categorical,"
"0","    continuous_vars = continuous_vars,"
"0","    cycle = cycle_name"
"0","  ))"
"0","}"
"0",""
"0","# Prepare clustering data for each cycle"
"0","cycle_prepared_data <- list()"
"0",""
"0","for (cycle_name in names(processed_list)) {"
"0","  if (!is.null(processed_list[[cycle_name]])) {"
"0","    "
"0","    cycle_vars <- cycle_variable_analysis[[cycle_name]]$clustering_vars"
"0","    "
"0","    cycle_prepared_data[[cycle_name]] <- prepare_cycle_clustering_data("
"0","      processed_list[[cycle_name]], "
"0","      cycle_vars, "
"0","      cycle_name"
"0","    )"
"0","  }"
"0","}"
"1","→ Preparing clustering dataset for PISA 2015...
"
"1","✓ Retained 1373 students (100.0%)
"
"1","✓ Variable types: 14 continuous, 6 categorical
"
"1","→ Preparing clustering dataset for PISA 2018...
"
"1","✓ Retained 1589 students (99.7%)
"
"1","✓ Variable types: 20 continuous, 6 categorical
"
"1","→ Preparing clustering dataset for PISA 2022...
"
"1","⚠ Dropped 1 variables due to missingness
"
"1","✓ Retained 1579 students (100.0%)
"
"1","✓ Variable types: 13 continuous, 6 categorical
"
"0","cat(""\n✓ Data preparation completed for all cycles\n"")"
"1","
✓ Data preparation completed for all cycles
"
"0","# Summary"
"0","cat(""\n=== CYCLE-SPECIFIC DATASET SUMMARY ===\n"")"
"1","
=== CYCLE-SPECIFIC DATASET SUMMARY ===
"
"0","for (cycle_name in names(cycle_prepared_data)) {"
"0","  data_info <- cycle_prepared_data[[cycle_name]]"
"0","  cat(sprintf(""PISA %s: %d students × %d variables (%d cont., %d cat.)\n"","
"0","              cycle_name, "
"0","              nrow(data_info$data),"
"0","              length(data_info$clustering_vars),"
"0","              length(data_info$continuous_vars),"
"0","              length(data_info$categorical_vars)))"
"0","}"
"1","PISA 2015: 1373 students × 20 variables (14 cont., 6 cat.)
"
"1","PISA 2018: 1589 students × 26 variables (20 cont., 6 cat.)
"
"1","PISA 2022: 1579 students × 19 variables (13 cont., 6 cat.)
"
